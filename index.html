<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>一斗夢包棟民宿 | 房況前台（唯讀）</title>
  <style>
    :root{
      --bg:#f7f8fa; --fg:#222; --muted:#666;
      --ok:#c8e6c9; --bad:#ffcdd2; --pink:#fff8f8;
      --today:#fff8d6; --border:#dcdcdc; --sticky:#ffffffee;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,Helvetica,sans-serif;margin:24px;background:var(--bg);color:var(--fg)}
    h2{margin:6px 0 12px;text-align:center}
    .wrap{max-width:1200px;margin:0 auto}
    .controls{display:grid;gap:8px;grid-template-columns:repeat(8,auto);align-items:center;background:#fff;padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    label{display:flex;gap:8px;align-items:center;color:var(--muted)}
    input[type="month"],select{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;color:#000}
    button{padding:10px 14px;background:#e9eefb;border:none;color:#0f2d62;border-radius:10px;cursor:pointer;font-weight:600}
    button:hover{background:#dfe7fb}
    .legend{display:flex;gap:12px;align-items:center;font-size:14px;color:#444;margin:6px 0 14px}
    .dot{width:14px;height:14px;border-radius:4px;display:inline-block;border:1px solid var(--border);margin-right:6px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .calendar{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .cal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--sticky);position:sticky;top:0;z-index:1}
    .cal-title{font-weight:700}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:center}
    thead th{font-size:12px;color:#666;background:#fafafa;position:sticky;top:48px;z-index:1}

    .day{border-left:1px solid var(--border);min-height:52px;vertical-align:top;position:relative;background:#fff}
    .day:first-child{border-left:none}
    .dateNo{position:absolute;left:6px;top:6px;font-size:12px;color:#555;z-index:2}

    .state{margin-top:22px;display:inline-block;padding:6px 8px;border-radius:8px;border:1px solid var(--border);font-weight:600;line-height:1.1}
    .full{background:var(--bad)}
    .available{background:var(--ok)}
    .clickable{cursor:pointer; transition:box-shadow .15s ease}
    .clickable:hover{box-shadow:0 0 0 3px rgba(19,99,223,.15)}

    .is-today{background:var(--today)}
    .today-dot{position:absolute;right:6px;top:6px;width:8px;height:8px;border-radius:50%;background:#e53935;box-shadow:0 0 0 2px #fff}
    .weekend{background:var(--pink)}
    .muted{color:#aaa}

    .past{opacity:.6;pointer-events:none}
    .past .state{display:none}
    .past::after{
      content:"佔位";visibility:hidden;display:inline-block;margin-top:22px;padding:6px 8px;border:1px solid transparent;border-radius:8px;font-weight:600;line-height:1.1;
    }

    .footer{margin-top:12px;color:#666;font-size:13px}
    .counts{font-variant-numeric:tabular-nums}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} .controls{grid-template-columns:1fr 1fr;row-gap:10px} }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>房況前台（唯讀）</h2>

    <div class="controls">
      <label>年份
        <select id="yearSelect"></select>
      </label>
      <label>起始月份
        <input id="startMonth" type="month">
      </label>
      <button id="btnPrev3">← 前 3 個月</button>
      <button id="btnNext3">後 3 個月 →</button>
      <button id="btnToday">今天</button>
      <button id="btnReload">重新整理</button>
      <span style="justify-self:end" id="lastSync">未同步</span>
    </div>

    <div class="legend">
      <span><span class="dot" style="background:var(--ok)"></span>可售</span>
      <span><span class="dot" style="background:var(--bad)"></span>已滿</span>
      <span><span class="dot" style="background:var(--pink); border-color:#f4b4b4"></span>週末</span>
      <span><span class="dot" style="background:var(--today); box-shadow: inset 0 0 0 2px #ff85c0"></span>今天</span>
    </div>

    <div id="calendars" class="grid" aria-label="三個月月曆"></div>

    <div class="footer">
      <div>API：<span id="apiBase"></span></div>
    </div>
  </div>

  <script>
  (function(){
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyX3WVu_DLrx0gRehHButc0fjsjqRuS23UAjOPZWhy9nOt-cYOxIgMCLUu-OcV1n15f8g/exec';
    const PHONE = '0905385388';
    const AUTO_REFRESH_MS = 30000;

    // 範圍：從本月開始僅顯示未來一年
    const NOW = new Date();
    const MIN_DATE = new Date(NOW.getFullYear(), NOW.getMonth(), 1);
    const MAX_DATE = new Date(NOW.getFullYear(), NOW.getMonth()+11, 1);

    const CACHE = {};
    let lastViewHash = '';
    let pendingGetAbort = null;

    const fmt=(d)=>d.toISOString().slice(0,10);
    const todayStr=fmt(new Date());
    const startOfMonth=(d)=>new Date(d.getFullYear(), d.getMonth(), 1);
    const addMonths=(d,n)=>new Date(d.getFullYear(), d.getMonth()+n, 1);
    const ymd=(y,m,day)=>`${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const isWeekend=(y,m,day)=>{const wd=new Date(y,m-1,day).getDay();return wd===0||wd===6;};

    function clampMonth(d){
      const s = startOfMonth(d);
      if(s < MIN_DATE) return new Date(MIN_DATE);
      if(s > MAX_DATE) return new Date(MAX_DATE);
      return s;
    }
    function setStartMonthFromDate(d){
      const el = document.getElementById('startMonth');
      const s = clampMonth(d);
      el.value = `${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,'0')}`;
    }
    function getStartMonthDate(){
      const el=document.getElementById('startMonth');
      const [Y,M]=el.value.split('-').map(v=>parseInt(v,10));
      return clampMonth(new Date(Y, M-1, 1));
    }

    function initSelectors(){
      const elYear=document.getElementById('yearSelect');
      const curY = MIN_DATE.getFullYear();
      const maxY = MAX_DATE.getFullYear();
      elYear.innerHTML='';
      for(let y=curY; y<=maxY; y++){
        const opt=document.createElement('option');
        opt.value=String(y); opt.textContent=y;
        if(y===curY) opt.selected=true;
        elYear.appendChild(opt);
      }
      const elMonth = document.getElementById('startMonth');
      elMonth.min = `${MIN_DATE.getFullYear()}-${String(MIN_DATE.getMonth()+1).padStart(2,'0')}`;
      elMonth.max = `${MAX_DATE.getFullYear()}-${String(MAX_DATE.getMonth()+1).padStart(2,'0')}`;
      setStartMonthFromDate(NOW);
      document.getElementById('apiBase').textContent = API_BASE;
    }

    function getState(year,ds){return(CACHE[year]&&CACHE[year][ds]==='full')?'full':'available';}

    async function fetchYear(year){
      if (pendingGetAbort) pendingGetAbort.abort();
      const ctl = new AbortController();
      pendingGetAbort = ctl;

      const u=new URL(API_BASE);u.searchParams.set('year',String(year));u.searchParams.set('t',Date.now());
      const res=await fetch(u.toString(),{headers:{'Accept':'application/json'},cache:'no-store',signal:ctl.signal});
      if(!res.ok) throw new Error('API GET failed '+res.status);
      const data=await res.json();
      CACHE[year]=data.status||{};
      document.getElementById('lastSync').textContent='讀取於 '+new Date().toLocaleString();
      pendingGetAbort = null;
      return CACHE[year];
    }

    // ==== 事件委派：只掛一次（點「可售」徽章才撥號）====
    document.getElementById('calendars').addEventListener('click', (ev) => {
      const el = ev.target.closest('.state.available.clickable');
      if (!el) return;
      window.location.href = `tel:${PHONE}`;
    });

    function renderCalendars(){
      const holder=document.getElementById('calendars');
      let base = getStartMonthDate();
      const months = [];
      for(let k=0;k<3;k++){
        const d = addMonths(base, k);
        if(d > MAX_DATE) break;
        months.push({y:d.getFullYear(), m:d.getMonth()+1});
      }

      // 以字串拼接，最後一次性注入（效能佳）
      let html = '';
      for (const {y,m} of months) {
        const firstWd = new Date(y,m-1,1).getDay();
        const lastDay = new Date(y,m,0).getDate();
        let rowsHtml = '<tr>'+ '<td></td>'.repeat(firstWd);

        let fullCount=0, freeCount=0;
        for (let d=1; d<=lastDay; d++) {
          const dstr = ymd(y,m,d);
          const isPast = dstr < todayStr;
          const isToday = dstr === todayStr;
          const weekend = isWeekend(y,m,d) ? ' weekend' : '';
          const todayCls = isToday ? ' is-today' : '';
          const pastCls = isPast ? ' past muted' : '';
          let cell = `<td class="day${weekend}${todayCls}${pastCls}" data-y="${y}" data-m="${m}" data-d="${d}">`;
          cell += `<span class="dateNo">${d}</span>`;
          if (isToday) cell += `<span class="today-dot"></span>`;
          if (!isPast) {
            const st = getState(y, dstr);
            const cls = st==='full' ? 'full' : 'available';
            const label = st==='full' ? '已滿' : '可售';
            const clickable = st==='available' ? ' clickable' : '';
            cell += `<span class="state ${cls}${clickable}">${label}</span>`;
            if (st==='full') fullCount++; else freeCount++;
          }
          cell += `</td>`;
          rowsHtml += cell;

          if ((firstWd + d) % 7 === 0 && d !== lastDay) {
            rowsHtml += '</tr><tr>';
          }
        }
        rowsHtml += '</tr>';

        html += `
          <div class="calendar">
            <div class="cal-head">
              <div class="cal-title">${y} 年 ${m} 月</div>
              <div class="counts" id="cnt-${y}-${m}">可售 ${String(freeCount).padStart(2,'0')} • 已滿 ${String(fullCount).padStart(2,'0')}</div>
            </div>
            <table>
              <thead><tr><th>日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th></tr></thead>
              <tbody>${rowsHtml}</tbody>
            </table>
          </div>`;
      }
      holder.innerHTML = html;
    }

    function hashVisibleView(){
      const base = getStartMonthDate();
      const months = [];
      for(let k=0;k<3;k++){
        const d = addMonths(base, k);
        if(d > MAX_DATE) break;
        months.push(d);
      }
      const pick = {};
      for (const d of months) {
        const y=d.getFullYear(), m=d.getMonth()+1;
        const last = new Date(y,m,0).getDate();
        for (let day=1; day<=last; day++) {
          const ds = ymd(y,m,day);
          pick[ds] = (CACHE[y] && CACHE[y][ds]) || 'free';
        }
      }
      return JSON.stringify(pick);
    }

    async function reloadNow(){
      const btn=document.getElementById('btnReload');
      const last=document.getElementById('lastSync');
      try{
        if(btn){btn.disabled=true;btn.textContent='重新整理中…';}
        if(last){last.textContent='重新整理中…';}

        // 只抓「畫面會用到的年份」
        const base = getStartMonthDate();
        const years = new Set();
        for (let k=0;k<3;k++){
          const d = addMonths(base, k);
          if (d > MAX_DATE) break;
          years.add(d.getFullYear());
        }
        for (const y of years){ await fetchYear(y); }

        // 資料若未變，不重繪
        const newHash = hashVisibleView();
        if (newHash !== lastViewHash) {
          lastViewHash = newHash;
          renderCalendars();
        }
        if(last){last.textContent='讀取於 '+new Date().toLocaleString();}
      }catch(e){
        console.error(e);
        alert('重新整理失敗：'+(e?.message||e));
        if(last){last.textContent='讀取失敗';}
      }finally{
        if(btn){btn.disabled=false;btn.textContent='重新整理';}
      }
    }

    function shiftMonths(n){ setStartMonthFromDate(addMonths(getStartMonthDate(), n)); reloadNow(); }
    function goToday(){ setStartMonthFromDate(NOW); reloadNow(); }

    document.getElementById('btnReload').onclick=reloadNow;
    document.getElementById('btnPrev3').onclick=()=>shiftMonths(-3);
    document.getElementById('btnNext3').onclick=()=>shiftMonths(3);
    document.getElementById('btnToday').onclick=goToday;
    document.getElementById('yearSelect').addEventListener('change', reloadNow);
    document.getElementById('startMonth').addEventListener('change', ()=>{
      setStartMonthFromDate(getStartMonthDate()); // clamp
      reloadNow();
    });

    let refreshing=false;
    setInterval(async ()=>{
      if(refreshing) return;
      refreshing=true;
      try{ await reloadNow(); }catch(e){ console.error(e); }
      refreshing=false;
    }, AUTO_REFRESH_MS);

    (async function init(){
      initSelectors();
      await reloadNow();
    })();
  })();
  </script>
</body>
</html>
