<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>一斗夢包棟民宿 | 空房表（查詢）</title>
  <style>
    :root{
      --bg:#f7f8fa; --fg:#222; --muted:#666; --brand:#1363df; --brand-600:#0f57c5;
      --ok:#c8e6c9; --bad:#ffcdd2; --pink:#fff8f8;   /* 週末底色對齊網站 */
      --today:#fff8d6;                                /* 今日淡黃底（保留你的設定） */
      --border:#dcdcdc; --sticky:#ffffffee;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,Helvetica,sans-serif;margin:24px;background:var(--bg);color:var(--fg)}
    h2{margin:6px 0 8px;text-align:center}
    .wrap{max-width:1100px;margin:0 auto}
    .controls{
      display:grid;
      grid-template-columns:repeat(6,auto);
      gap:8px;
      align-items:center;
      background:#fff;
      padding:12px;
      border:1px solid var(--border);
      border-radius:12px;
      margin-bottom:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.04)
    }
    label{display:flex;gap:8px;align-items:center;color:var(--muted)}
    input[type="month"],select{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;color:#000}
    button{padding:10px 14px;background:var(--brand);border:none;color:#fff;border-radius:10px;cursor:pointer;font-weight:600}
    button:hover{background:var(--brand-600)}
    .secondary{background:#e9eefb;color:#0f2d62}
    .legend{display:flex;gap:12px;align-items:center;font-size:14px;color:#444;margin:6px 0 14px}
    .dot{width:14px;height:14px;border-radius:4px;display:inline-block;border:1px solid var(--border);margin-right:6px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .calendar{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .cal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--sticky);position:sticky;top:0;z-index:1}
    .cal-title{font-weight:700}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:center}
    thead th{font-size:12px;color:#666;background:#fafafa;position:sticky;top:48px;z-index:1}

    /* 日期格 */
    .day{
      border-left:1px solid var(--border);
      min-height:52px;
      vertical-align:top;
      position:relative;
      background:#fff;
      cursor:default;             /* 前台唯讀，整格不是編輯手勢 */
    }
    .day:first-child{border-left:none}
    .dateNo{position:absolute;left:6px;top:6px;font-size:12px;color:#555;z-index:2}

    /* 膠囊徽章 */
    .state{
      margin-top:22px;
      display:inline-block;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      font-weight:600;
      line-height:1.1;
    }
    .full{background:var(--bad)}
    .free{background:var(--ok)}

    /* 可售電話連結 */
    .call-link{
      text-decoration:none;
      color:inherit;
    }
    .call-link .state{
      cursor:pointer;   /* 只有徽章是手指游標 */
    }

    /* 今天樣式 */
    .is-today{background:var(--today)}
    .today-dot{
      position:absolute;
      right:6px;
      top:6px;
      width:8px;
      height:8px;
      border-radius:50%;
      background:#e53935;
      box-shadow:0 0 0 2px #fff
    }

    /* 週末與過去日期 */
    .weekend{background:var(--pink)}
    .muted{color:#aaa}

    .past{opacity:.6; pointer-events:none}
    .past .state{display:none}
    .past::after{
      content:"佔位";
      visibility:hidden;
      display:inline-block;
      margin-top:22px;
      padding:6px 8px;
      border:1px solid transparent;
      border-radius:8px;
      font-weight:600;
      line-height:1.1;
    }

    .footer{margin-top:12px;color:#666;font-size:13px}
    .counts{font-variant-numeric:tabular-nums}
    .notice{color:#d32f2f;font-weight:600;text-align:center;margin-bottom:24px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .link{color:#0b5bd3;text-decoration:underline;cursor:pointer}
    @media (max-width: 960px){
      .grid{grid-template-columns:1fr}
      .controls{grid-template-columns:1fr 1fr;row-gap:10px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>一斗夢包棟民宿．空房表1126（僅供查詢）</h2>
    <p class="notice">
      房況僅供參考，如需訂房請撥打電話：
      <a href="tel:0905385388">0905385388</a>
      或官方加入 Line
      <a href="https://line.me/R/ti/p/@518bytys" target="_blank" rel="noopener">@518bytys</a>
    </p>

    <div class="controls">
      <label>點選日期
        <input id="startMonth" type="month">
      </label>
      <button id="btnPrev3" class="secondary">← 前 3 個月</button>
      <button id="btnNext3" class="secondary">後 3 個月 →</button>
      <button id="btnReload" class="secondary">今天</button>
      <span style="justify-self:end" id="lastSync" class="chip">未同步</span>
    </div>

    <div class="legend">
      <span><span class="dot" style="background:var(--ok)"></span>可售（點擊可撥打 0905385388）</span>
      <span><span class="dot" style="background:var(--bad)"></span>已滿</span>
      <span><span class="dot" style="background:var(--pink); border-color:#f4b4b4"></span>週末</span>
      <span class="chip"><span class="today-dot"></span> 今天（淡黃）</span>
      <span class="chip muted">灰色日期為今日之前，僅供參考</span>
    </div>

    <div id="calendars" class="grid" aria-label="三個月月曆"></div>

    </div>

  <script>
    // ====== 常數（請確認與後台使用同一個 /exec）======
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyX3WVu_DLrx0gRehHButc0fjsjqRuS23UAjOPZWhy9nOt-cYOxIgMCLUu-OcV1n15f8g/exec';
    // =============================================

    const CACHE = {}; // { [year:number]: { 'YYYY-MM-DD': 'full'|'free' } }

    // 工具
    const fmt = (d)=>d.toISOString().slice(0,10);
    const ymd = (y,m,day)=>`${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const todayStr = fmt(new Date());
    const isWeekend = (y,m,day)=>{ const wd=new Date(y,m-1,day).getDay(); return wd===0 || wd===6; };

    // ===== API GET（防快取）=====
    async function apiGet(year){
      const u = new URL(API_BASE);
      u.searchParams.set('year', String(year));
      u.searchParams.set('t', Date.now()); // 防止快取
      const res = await fetch(u.toString(), { headers:{ 'Accept':'application/json' }, cache:'no-store' });
      if(!res.ok) throw new Error('GET failed '+res.status);
      const json = await res.json();
      CACHE[year] = json?.status || {};
      const last = document.querySelector('#lastSync');
      if (last) last.textContent = '讀取於 ' + new Date().toLocaleString();
      return json;
    }

    // ===== 介面 =====
    const elMonth = document.getElementById('startMonth');
    const elCals = document.getElementById('calendars');

    function initSelectors(){
      const now = new Date();
      const curYear = now.getFullYear();

      // 最小：本月
      const minMonth = `${curYear}-${String(now.getMonth()+1).padStart(2,'0')}`;
      elMonth.min = minMonth;

      // 最大：往後近兩年（本月起 24 個月內）
      const maxDate = new Date(now.getFullYear(), now.getMonth()+23, 1); // 0-based 月份
      const maxMonth = `${maxDate.getFullYear()}-${String(maxDate.getMonth()+1).padStart(2,'0')}`;
      elMonth.max = maxMonth;

      // 預設顯示本月
      elMonth.value = minMonth;
    }

    function monthDays(y,m){
      const last = new Date(y, m, 0).getDate();
      return Array.from({length:last}, (_,i)=>i+1);
    }

    // 只抓畫面會用到、且尚未在 CACHE 裡的年份
    async function ensureYearsLoadedForView(){
      const [Y, M] = elMonth.value.split('-').map(v => parseInt(v, 10));

      const years = new Set();
      for (let k = 0; k < 3; k++) {
        let y = Y, m = M + k;
        if (m > 12) {
          y += Math.floor((m - 1) / 12);
        }
        years.add(y);
      }

      const tasks = [];
      for (const y of years) {
        if (!CACHE[y]) {
          tasks.push(apiGet(y));
        }
      }
      if (tasks.length) {
        await Promise.all(tasks);
      }
    }

    async function loadYearAndRender(){
      await ensureYearsLoadedForView();
      renderCalendars();
    }

    function renderCalendars(){
      let [Y, M] = elMonth.value.split('-').map(v=>parseInt(v,10));
      const [minY, minM] = elMonth.min.split('-').map(v=>parseInt(v,10));
      const [maxY, maxM] = elMonth.max.split('-').map(v=>parseInt(v,10));

      // 不可早於 min，也不可晚於 max
      if (Y < minY || (Y===minY && M<minM)) {
        Y = minY; M = minM;
        elMonth.value = `${Y}-${String(M).padStart(2,'0')}`;
      } else if (Y > maxY || (Y===maxY && M>maxM)) {
        Y = maxY; M = maxM;
        elMonth.value = `${Y}-${String(M).padStart(2,'0')}`;
      }

      const months = [0,1,2].map(k=>{
        let y=Y, m=M+k;
        if(m>12){ y += Math.floor((m-1)/12); m = ((m-1)%12)+1; }
        return {y, m};
      });

      elCals.innerHTML = '';
      months.forEach(({y,m})=>{
        const cal = document.createElement('div');
        cal.className = 'calendar';

        const head = document.createElement('div');
        head.className = 'cal-head';
        head.innerHTML = `<div class="cal-title">${y} 年 ${m} 月</div><div class="counts" id="cnt-${y}-${m}"></div>`;
        cal.appendChild(head);

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
          <th>日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th>
        </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        const firstWd = new Date(y,m-1,1).getDay(); // 0=Sun..6=Sat
        const days = monthDays(y,m);
        let row = document.createElement('tr');
        for(let i=0;i<firstWd;i++) row.appendChild(document.createElement('td'));

        days.forEach(day=>{
          const td = document.createElement('td');
          const dstr = ymd(y,m,day);
          const isPast = dstr < todayStr;
          const isToday = dstr === todayStr;

          td.className = 'day'
            + (isWeekend(y,m,day)?' weekend':'')
            + (isToday?' is-today':'')
            + (isPast?' past muted':'');

          let inner = `<span class="dateNo">${day}</span>`;
          if (isToday) inner += `<span class="today-dot"></span>`;
          if (!isPast) {
            const state = (CACHE[y]?.[dstr] || 'free');
            if (state === 'full') {
              inner += `<span class="state full">已滿</span>`;
            } else {
              inner += `<a href="tel:0905385388" class="call-link"><span class="state free">可售</span></a>`;
            }
          }
          td.innerHTML = inner;

          row.appendChild(td);
          if((firstWd + day) % 7 === 0){
            tbody.appendChild(row);
            row = document.createElement('tr');
          }
        });
        if(row.children.length) tbody.appendChild(row);

        table.appendChild(tbody);
        cal.appendChild(table);
        elCals.appendChild(cal);

        updateCounts(y,m);
      });
    }

    function updateCounts(y,m){
      const days = monthDays(y,m);
      let full=0, free=0;
      days.forEach(d=>{
        const dstr = ymd(y,m,d);
        if(dstr < todayStr) return; // 今日之前不計入
        const st = (CACHE[y]?.[dstr] || 'free');
        if(st==='full') full++; else free++;
      });
      const el = document.getElementById(`cnt-${y}-${m}`);
      if(el) el.textContent = `可售 ${String(free).padStart(2,'0')} • 已滿 ${String(full).padStart(2,'0')}`;
    }

    // 抓目前起始月份的 3 個月
    async function reloadNow(){
      const btn = document.getElementById('btnReload');
      const last = document.getElementById('lastSync');
      try{
        btn.disabled = true;
        btn.textContent = '讀取中…';
        if(last) last.textContent = '讀取中…';
        await loadYearAndRender();
        if(last) last.textContent = '讀取於 ' + new Date().toLocaleString();
      }catch(err){
        console.error(err);
        alert('重新載入失敗：' + (err?.message || err));
        if(last) last.textContent = '讀取失敗';
      }finally{
        btn.disabled = false;
        btn.textContent = '今天';
      }
    }

    // 「今天」按鈕：跳回今天所在月份（限制在 min/max 內）
    function goToday(){
      const now = new Date();
      let Y = now.getFullYear();
      let M = now.getMonth() + 1;

      const [minY, minM] = elMonth.min.split('-').map(v => parseInt(v, 10));
      const [maxY, maxM] = elMonth.max.split('-').map(v => parseInt(v, 10));

      if (Y < minY || (Y === minY && M < minM)) {
        Y = minY; M = minM;
      } else if (Y > maxY || (Y === maxY && M > maxM)) {
        Y = maxY; M = maxM;
      }

      elMonth.value = `${Y}-${String(M).padStart(2,'0')}`;
      reloadNow();
    }

    function shiftMonths(n){
      const [minY, minM] = elMonth.min.split('-').map(v=>parseInt(v,10));
      const [maxY, maxM] = elMonth.max.split('-').map(v=>parseInt(v,10));

      const minDate = new Date(minY, minM-1, 1);
      const maxDate = new Date(maxY, maxM-1, 1);

      const cur = elMonth.value.split('-').map(v=>parseInt(v,10));
      let base = new Date(cur[0], cur[1]-1, 1);
      base.setMonth(base.getMonth() + n);

      if (base < minDate) base = minDate;
      if (base > maxDate) base = maxDate;

      elMonth.value = `${base.getFullYear()}-${String(base.getMonth()+1).padStart(2,'0')}`;
      reloadNow();
    }

    // 事件
    document.getElementById('btnReload').addEventListener('click', goToday);
    document.getElementById('btnPrev3').addEventListener('click', ()=>shiftMonths(-3));
    document.getElementById('btnNext3').addEventListener('click', ()=>shiftMonths(3));

    // 初始化
    (async function(){
      initSelectors();
      const apiSpan = document.getElementById('apiBase');
      apiSpan.textContent = API_BASE;
      apiSpan.addEventListener('click', ()=>window.open(API_BASE,'_blank'));
      await loadYearAndRender();
      elMonth.addEventListener('change', reloadNow);
    })();
  </script>
</body>
</html>
