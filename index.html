<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>一斗夢包棟民宿 | 空房表（查詢）</title>
  
  <meta property="og:title" content="一斗夢包棟民宿 | 即時房況查詢" />
  <meta property="og:description" content="查看一斗夢最新空房表，歡迎包棟預訂！" />
  <meta property="og:url" content="https://kadasup.github.io/room/" />
  <meta property="og:image" content="https://kadasup.github.io/room/cover.jpg" />
  <meta property="og:type" content="website" />

  <style>
    :root{
      --bg:#f7f8fa; --fg:#222; --muted:#666; --brand:#1363df; --brand-600:#0f57c5;
      --ok:#c8e6c9; --bad:#ffcdd2; --pink:#fff8f8;
      --today:#fff8d6;
      --border:#dcdcdc; --sticky:#ffffffee;
      --holiday-text: #e53935; /* 假日文字紅 */
    }
    *{box-sizing:border-box}
    
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,Helvetica,sans-serif;
      margin: 16px 12px;
      background:var(--bg);
      color:var(--fg);
      -webkit-tap-highlight-color: transparent;
    }

    h2{margin:6px 0 8px;text-align:center; font-size: 1.4rem;}
    .wrap{max-width:1100px;margin:0 auto}

    /* --- 操作面板 --- */
    .controls{
      display:grid;
      grid-template-columns: auto auto auto auto auto 1fr;
      gap: 10px;
      align-items:center;
      background:#fff;
      padding:12px;
      border:1px solid var(--border);
      border-radius:12px;
      margin-bottom:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    
    label{display:flex;gap:8px;align-items:center;color:var(--muted); font-weight: 500;}
    input[type="month"]{
      padding:8px; border:1px solid var(--border); border-radius:8px; background:#fff; color:#000; font-size: 15px;
    }

    /* 按鈕樣式 */
    button{
      padding:10px 14px;
      background:var(--brand);
      border:none;
      color:#fff;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      font-size: 14px;
      transition: background .2s;
    }
    button:active{transform: scale(0.98);}
    button:hover{background:var(--brand-600)}

    /* 次要按鈕強制淡色 */
    button.secondary{ background:#e9eefb; color:#0f2d62; }
    button.secondary:hover, 
    button.secondary:focus, 
    button.secondary:active { background: #dce5f6; color: #0f2d62; }

    .legend{
      display:flex;
      flex-wrap: wrap;
      gap:8px 16px;
      align-items:center;
      font-size:13px;
      color:#444;
      margin:6px 0 14px;
      justify-content: center;
    }
    .dot{width:12px;height:12px;border-radius:4px;display:inline-block;border:1px solid var(--border);margin-right:4px; vertical-align: middle;}
    
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    
    .calendar{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}
    .cal-head{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      background:var(--sticky);
      position:sticky; top:0; z-index:10;
    }
    .cal-title{font-weight:700; font-size: 1.1rem;}

    table{width:100%;border-collapse:separate;border-spacing:0; table-layout: fixed;}
    th,td{border-bottom:1px solid var(--border);padding:4px 2px;text-align:center}
    
    thead th{
      font-size:12px; color:#666; background:#fafafa;
      position:sticky; top:50px; z-index:9;
      padding-top:10px; padding-bottom:10px;
    }

    .day{
      border-left:1px solid var(--border);
      height: 72px;
      vertical-align:top;
      position:relative;
      background:#fff;
      cursor:default;
    }
    .day:first-child{border-left:none}
    
    /* 日期數字 */
    .dateNo{position:absolute;left:4px;top:4px;font-size:11px;color:#555;z-index:2; font-family: monospace;}
    
    /* 假日樣式 */
    .is-holiday .dateNo { color: var(--holiday-text); font-weight: bold; }
    .holiday-name {
      position: absolute;
      right: 4px;
      top: 4px;
      font-size: 10px;
      color: var(--holiday-text);
      font-weight: bold;
      z-index: 2;
    }

    .state{
      margin-top:28px;
      display:block;
      margin-left: auto; margin-right: auto;
      padding:4px 0;
      border-radius:6px;
      border:1px solid var(--border);
      font-weight:600;
      line-height:1.2;
      font-size: 13px;
      width: 90%; 
      max-width: 60px;
    }
    .full{background:var(--bad); color: #b71c1c; border-color: #ef9a9a;}
    .free{background:var(--ok); color: #1b5e20; border-color: #a5d6a7;}
    .loading{background:#f5f5f5; color:#aaa; border:1px dashed #ddd; font-size: 11px;}

    .past-state {
      background: #f9f9f9; color: #ddd; border-color: #eee;
      pointer-events: none;
    }

    .call-link{text-decoration:none; color:inherit; display: block;}

    .is-today{background:var(--today)}
    
    .today-dot{
      position:absolute; right:4px; top:18px; 
      width:6px; height:6px; border-radius:50%; background:#e53935; box-shadow:0 0 0 2px #fff;
    }
    .day:not(.is-holiday) .today-dot { top: 4px; }

    .weekend{background:var(--pink)}
    .muted{color:#aaa}
    .past{opacity:1; background: #fff;}
    .past .dateNo { color: #ccc; }
    .past .holiday-name { color: #e57373; opacity: 0.6; }

    .footer{
      margin-top:20px;
      margin-bottom: 60px;
      color: #d32f2f;
      font-size: 13px;
      font-weight: 700;
      text-align: center;
    }
    
    .counts{font-variant-numeric:tabular-nums; font-size: 13px;}
    .notice{
      color:#d32f2f; font-weight:600; text-align:center; margin-bottom:16px; 
      font-size: 14px; line-height: 1.5;
      background: #ffebee; padding: 10px; border-radius: 8px;
    }
    .notice a { color: #d32f2f; text-decoration: underline; }
    .chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff; font-size: 12px;}
    .link{color:#0b5bd3;text-decoration:underline;cursor:pointer}

    .btn-top {
      position: fixed; bottom: 24px; right: 24px; width: 44px; height: 44px;
      border-radius: 50%; background: var(--brand); color: #fff; border: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; z-index: 99; opacity: 0; visibility: hidden;
      transform: translateY(10px); transition: all 0.3s ease;
    }
    .btn-top.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .btn-top:active { transform: scale(0.95); }

    @media (max-width: 768px){
      .grid{grid-template-columns:1fr}
      .controls{ display: flex; flex-wrap: wrap; gap: 10px; }
      .controls label { width: 100%; justify-content: space-between; }
      .controls label input { flex-grow: 1; text-align: center; }
      #btnPrev3, #btnNext3, #btnReload { flex: 1; padding: 12px 0; text-align: center; font-size: 13px; }
      #lastSync { margin-left: auto; font-size: 11px; color: #888; border: none; background: transparent; padding: 0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>一斗夢包棟民宿</h2>
    <p class="notice">
      如需訂房請撥打電話：
      <a href="tel:0905385388">0905385388</a><br>
      或加 Line ID：
      <a href="https://line.me/R/ti/p/@518bytys" target="_blank" rel="noopener">@518bytys</a>
    </p>

    <div class="controls">
      <label>查詢月份
        <input id="startMonth" type="month">
      </label>
      <button id="btnPrev3" class="secondary">← 上一季</button>
      <button id="btnReload" class="secondary">回到本月</button>
      <button id="btnNext3" class="secondary">下一季 →</button>
      <span id="lastSync" class="chip">未同步</span>
    </div>

    <div class="legend">
      <span><span class="dot" style="background:var(--ok)"></span>可售</span>
      <span><span class="dot" style="background:var(--bad)"></span>已滿</span>
      <span class="chip" style="background:var(--today); border-color:#e6e6e6"><span class="today-dot" style="position:static;display:inline-block"></span> 今天</span>
      <span class="chip muted" style="border:none; background:transparent">紅字為國定假日</span>
    </div>

    <div id="calendars" class="grid" aria-label="三個月月曆"></div>

    <div class="footer">
      <div>房況僅供參考 | 以小管家回覆為主</div>
    </div>
  </div>

  <button id="btnTop" class="btn-top" aria-label="回到頂部">↑</button>

  <script>
    // ====== 常數 ======
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyX3WVu_DLrx0gRehHButc0fjsjqRuS23UAjOPZWhy9nOt-cYOxIgMCLUu-OcV1n15f8g/exec';
    
    // ★ 假日資料儲存處 (自動聯網更新)
    const HOLIDAYS = {}; 
    const FETCHED_YEARS = new Set(); // 記錄已經抓過哪一年的假日
    // =============================================

    const CACHE = {}; 

    const fmt = (d)=>d.toISOString().slice(0,10);
    const ymd = (y,m,day)=>`${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const todayStr = fmt(new Date());
    const isWeekend = (y,m,day)=>{ const wd=new Date(y,m-1,day).getDay(); return wd===0 || wd===6; };

    // ★ 1. 抓取假日資料的函數 (來源：政府行政機關辦公日曆表開源 API)
    async function loadTaiwanHolidays(year) {
      if (FETCHED_YEARS.has(year)) return; // 抓過就不抓
      
      const url = `https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${year}.json`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('No holiday data');
        const list = await res.json();
        
        list.forEach(item => {
          if (item.isHoliday && item.description) {
            // 轉換日期格式 20250101 -> 2025-01-01
            const d = item.date;
            const dateStr = `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`;
            
            // 簡化名稱
            let name = item.description;
            if (name.includes('開國紀念日')) name = '元旦';
            else if (name.includes('和平紀念日')) name = '228';
            else if (name.includes('國慶')) name = '國慶';
            else if (name.includes('兒童') && name.includes('掃墓')) name = '清明兒童';
            else if (name.includes('除夕')) name = '除夕';
            else if (name.includes('春節')) name = '春節';
            else if (name.includes('端午')) name = '端午';
            else if (name.includes('中秋')) name = '中秋';
            else if (name.includes('光復')) name = '光復';
            else if (name.includes('孔子')) name = '教師節';
            
            HOLIDAYS[dateStr] = name;
          }
        });
        FETCHED_YEARS.add(year);
      } catch (e) {
        console.warn(`無法載入 ${year} 年假日:`, e);
        // 失敗時避免重複嘗試
        FETCHED_YEARS.add(year);
      }
    }

    async function apiGet(year){
      const u = new URL(API_BASE);
      u.searchParams.set('year', String(year));
      u.searchParams.set('t', Date.now()); 
      try {
        const res = await fetch(u.toString(), { headers:{ 'Accept':'application/json' }, cache:'no-store' });
        if(!res.ok) throw new Error('GET failed '+res.status);
        const json = await res.json();
        CACHE[year] = json?.status || {};
        return json;
      } catch (e) {
        console.error("API Error:", e);
        CACHE[year] = {}; 
        return {};
      }
    }

    const elMonth = document.getElementById('startMonth');
    const elCals = document.getElementById('calendars');
    const elSync = document.getElementById('lastSync');

    function initSelectors(){
      const now = new Date();
      const curYear = now.getFullYear();
      const minMonth = `${curYear}-${String(now.getMonth()+1).padStart(2,'0')}`;
      elMonth.min = minMonth;
      const maxDate = new Date(now.getFullYear(), now.getMonth()+23, 1);
      const maxMonth = `${maxDate.getFullYear()}-${String(maxDate.getMonth()+1).padStart(2,'0')}`;
      elMonth.max = maxMonth;
      elMonth.value = minMonth;
    }

    function monthDays(y,m){
      const last = new Date(y, m, 0).getDate();
      return Array.from({length:last}, (_,i)=>i+1);
    }

    async function ensureYearsLoadedForView(){
      const [Y, M] = elMonth.value.split('-').map(v => parseInt(v, 10));
      const years = new Set();
      for (let k = 0; k < 3; k++) {
        let y = Y, m = M + k;
        if (m > 12) { y += Math.floor((m - 1) / 12); }
        years.add(y);
      }
      
      // ★ 2. 確保這些年份的假日也一併載入
      const holidayTasks = [];
      for (const y of years) {
        holidayTasks.push(loadTaiwanHolidays(y));
      }
      
      const apiTasks = [];
      for (const y of years) {
        if (!CACHE[y]) { apiTasks.push(apiGet(y)); }
      }
      
      // 同時等待：假日資料 + 房況資料
      await Promise.all([...holidayTasks, ...apiTasks]);
    }

    async function loadYearAndRender(){
      renderCalendars(); 
      elSync.textContent = '讀取中...';
      await ensureYearsLoadedForView();
      renderCalendars();
      elSync.textContent = '更新於 ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function renderCalendars(){
      let [Y, M] = elMonth.value.split('-').map(v=>parseInt(v,10));
      const [minY, minM] = elMonth.min.split('-').map(v=>parseInt(v,10));
      const [maxY, maxM] = elMonth.max.split('-').map(v=>parseInt(v,10));

      if (Y < minY || (Y===minY && M<minM)) {
        Y = minY; M = minM;
        elMonth.value = `${Y}-${String(M).padStart(2,'0')}`;
      } else if (Y > maxY || (Y===maxY && M>maxM)) {
        Y = maxY; M = maxM;
        elMonth.value = `${Y}-${String(M).padStart(2,'0')}`;
      }

      const months = [0,1,2].map(k=>{
        let y=Y, m=M+k;
        if(m>12){ y += Math.floor((m-1)/12); m = ((m-1)%12)+1; }
        return {y, m};
      });

      elCals.innerHTML = '';
      months.forEach(({y,m})=>{
        const cal = document.createElement('div');
        cal.className = 'calendar';

        const head = document.createElement('div');
        head.className = 'cal-head';
        head.innerHTML = `<div class="cal-title">${y} 年 ${m} 月</div><div class="counts" id="cnt-${y}-${m}"></div>`;
        cal.appendChild(head);

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr><th>日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th></tr>`;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        const firstWd = new Date(y,m-1,1).getDay();
        const days = monthDays(y,m);
        let row = document.createElement('tr');
        for(let i=0;i<firstWd;i++) row.appendChild(document.createElement('td'));

        days.forEach(day=>{
          const td = document.createElement('td');
          const dstr = ymd(y,m,day);
          const isPast = dstr < todayStr;
          const isToday = dstr === todayStr;
          
          // ★ 3. 從自動抓取的 HOLIDAYS 物件中檢查
          const holidayName = HOLIDAYS[dstr];

          td.className = 'day'
            + (isWeekend(y,m,day)?' weekend':'')
            + (isToday?' is-today':'')
            + (isPast?' past':'')
            + (holidayName ? ' is-holiday' : '');

          let inner = `<span class="dateNo">${day}</span>`;
          
          if (holidayName) {
            inner += `<span class="holiday-name">${holidayName}</span>`;
          }

          if (isToday) inner += `<span class="today-dot"></span>`;
          
          const yearData = CACHE[y];

          if (!yearData) {
            inner += `<span class="state loading">...</span>`;
          } else {
            if (isPast) {
              inner += `<span class="state past-state">已過</span>`;
            } else {
              const state = (yearData[dstr] || 'free');
              if (state === 'full') {
                inner += `<span class="state full">已滿</span>`;
              } else {
                inner += `<a href="tel:0905385388" class="call-link"><span class="state free">可售</span></a>`;
              }
            }
          }
          td.innerHTML = inner;

          row.appendChild(td);
          if((firstWd + day) % 7 === 0){
            tbody.appendChild(row);
            row = document.createElement('tr');
          }
        });
        if(row.children.length) tbody.appendChild(row);
        table.appendChild(tbody);
        cal.appendChild(table);
        elCals.appendChild(cal);

        if (CACHE[y]) {
          updateCounts(y,m);
        } else {
          const el = document.getElementById(`cnt-${y}-${m}`);
          if(el) el.textContent = '...';
        }
      });
    }

    function updateCounts(y,m){
      const days = monthDays(y,m);
      let full=0, free=0;
      days.forEach(d=>{
        const dstr = ymd(y,m,d);
        if(dstr < todayStr) return;
        const st = (CACHE[y]?.[dstr] || 'free');
        if(st==='full') full++; else free++;
      });
      const el = document.getElementById(`cnt-${y}-${m}`);
      if(el) el.textContent = `可售 ${free} / 已滿 ${full}`;
    }

    async function reloadNow(){
      const btn = document.getElementById('btnReload');
      try{
        btn.disabled = true;
        btn.textContent = '...';
        await loadYearAndRender();
      }catch(err){
        alert('載入失敗，請檢查網路');
        elSync.textContent = '載入錯誤';
      }finally{
        btn.disabled = false;
        btn.textContent = '回到本月';
      }
    }

    function goToday(){
      const now = new Date();
      let Y = now.getFullYear();
      let M = now.getMonth() + 1;
      
      const [minY, minM] = elMonth.min.split('-').map(v => parseInt(v, 10));
      if (Y < minY || (Y === minY && M < minM)) { Y = minY; M = minM; }
      
      elMonth.value = `${Y}-${String(M).padStart(2,'0')}`;
      reloadNow();
    }

    function shiftMonths(n){
      const [minY, minM] = elMonth.min.split('-').map(v=>parseInt(v,10));
      const [maxY, maxM] = elMonth.max.split('-').map(v=>parseInt(v,10));
      const minDate = new Date(minY, minM-1, 1);
      const maxDate = new Date(maxY, maxM-1, 1);
      const cur = elMonth.value.split('-').map(v=>parseInt(v,10));
      let base = new Date(cur[0], cur[1]-1, 1);
      base.setMonth(base.getMonth() + n);

      if (base < minDate) base = minDate;
      if (base > maxDate) base = maxDate;

      elMonth.value = `${base.getFullYear()}-${String(base.getMonth()+1).padStart(2,'0')}`;
      reloadNow();
    }

    document.getElementById('btnReload').addEventListener('click', goToday);
    document.getElementById('btnPrev3').addEventListener('click', ()=>shiftMonths(-3));
    document.getElementById('btnNext3').addEventListener('click', ()=>shiftMonths(3));
    
    const btnTop = document.getElementById('btnTop');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        btnTop.classList.add('show');
      } else {
        btnTop.classList.remove('show');
      }
    });
    btnTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    (async function(){
      initSelectors();
      await loadYearAndRender();
      elMonth.addEventListener('change', reloadNow);
    })();
  </script>
</body>
</html>
