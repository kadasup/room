<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>一斗夢包棟民宿 | 後台（API版）</title>
  <style>
    :root{
      --bg:#f7f8fa; --fg:#222; --muted:#666; --brand:#1363df; --brand-600:#0f57c5;
      --ok:#c8e6c9; --bad:#ffcdd2; --redbg:#fdecea; --redtxt:#c62828; --today:#fff0f6; --border:#dcdcdc; --sticky:#ffffffee;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,Helvetica,sans-serif;margin:24px;background:var(--bg);color:var(--fg)}
    h2{margin:6px 0 12px;text-align:center}
    .wrap{max-width:1100px;margin:0 auto}
    .controls{display:grid;grid-template-columns:repeat(6,auto);gap:8px;align-items:center;background:#fff;padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    label{display:flex;gap:8px;align-items:center;color:var(--muted)}
    input[type="month"],select{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;color:#000}
    button{padding:10px 14px;background:var(--brand);border:none;color:#fff;border-radius:10px;cursor:pointer;font-weight:600}
    button:hover{background:var(--brand-600)}
    .secondary{background:#e9eefb;color:#0f2d62}
    .legend{display:flex;gap:12px;align-items:center;font-size:14px;color:#444;margin:6px 0 14px}
    .dot{width:14px;height:14px;border-radius:4px;display:inline-block;border:1px solid var(--border);margin-right:6px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .calendar{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .cal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--sticky);position:sticky;top:0;z-index:1}
    .cal-title{font-weight:700}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:center}
    thead th{font-size:12px;color:#666;background:#fafafa;position:sticky;top:48px;z-index:1}
    .day{cursor:pointer;border-left:1px solid var(--border);min-height:52px;vertical-align:top;position:relative}
    .day:first-child{border-left:none}
    .dateNo{position:absolute;left:6px;top:6px;font-size:12px;color:#555}
    .state{margin-top:22px;display:inline-block;padding:6px 8px;border-radius:8px;border:1px solid var(--border);font-weight:600}
    .full{background:var(--bad)}
    .free{background:var(--ok)}
    .is-today{box-shadow: inset 0 0 0 2px #ff85c0; background:var(--today)}
    .weekend{background:#fff8f8}
    .muted{color:#aaa}
    .footer{margin-top:12px;color:#666;font-size:13px}
    .counts{font-variant-numeric:tabular-nums}
    .notice{color:#d32f2f;font-weight:600}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .link{color:#0b5bd3;text-decoration:underline;cursor:pointer}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} .controls{grid-template-columns:1fr 1fr;row-gap:10px}}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>房況後台（API 版）</h2>

    <div class="controls">
      <label>年份
        <select id="yearSel"></select>
      </label>
      <label>起始月份
        <input id="startMonth" type="month">
      </label>
      <button id="btnReload" class="secondary">重新載入</button>
      <button id="btnSetSatFull" class="secondary">本月週六→已滿</button>
      <button id="btnSetAllFree" class="secondary">本月全部→可售</button>
      <span style="justify-self:end" id="lastSync" class="chip">未同步</span>
    </div>

    <div class="legend">
      <span><span class="dot" style="background:var(--ok)"></span>可售</span>
      <span><span class="dot" style="background:var(--bad)"></span>已滿</span>
      <span><span class="dot" style="background:#fff8f8; border-color:#f4b4b4"></span>週末</span>
      <span><span class="dot" style="background:var(--today); box-shadow: inset 0 0 0 2px #ff85c0"></span>今天</span>
    </div>

    <div id="calendars" class="grid" aria-label="三個月月曆"></div>

    <div class="footer">
      <div>API：<span id="apiBase" class="link"></span></div>
      <div class="notice">若遇「CORS/預檢」錯誤：請確認 Apps Script 網頁應用程式部署為「以 <b>我</b> 執行」且「<b>任何人</b> 可存取」，並確保本頁與前台使用同一個 /exec。</div>
    </div>
  </div>

  <script>
    // ====== 必填常數（請確認是同一個 /exec）======
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyX3WVu_DLrx0gRehHButc0fjsjqRuS23UAjOPZWhy9nOt-cYOxIgMCLUu-OcV1n15f8g/exec';
    const ADMIN_TOKEN = '1234567890';
    // =============================================

    // 簡單快取（記憶體）
    const CACHE = {}; // { [year:number]: { 'YYYY-MM-DD': 'full'|'free' } }

    // 工具
    const fmt = (d)=>d.toISOString().slice(0,10);
    const ymd = (y,m,day)=>`${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const isWeekend = (y,m,day)=>{ const wd=new Date(y,m-1,day).getDay(); return wd===0 || wd===6; };
    const todayStr = fmt(new Date());

    // ===== API GET：帶防快取 =====
    async function apiGet(year){
      const u = new URL(API_BASE);
      u.searchParams.set('year', String(year));
      u.searchParams.set('t', Date.now()); // 破快取
      const res = await fetch(u.toString(), {
        headers:{ 'Accept':'application/json' },
        cache:'no-store'
      });
      if(!res.ok) throw new Error('GET failed '+res.status);
      const json = await res.json();
      CACHE[year] = json?.status || {};
      document.querySelector('#lastSync').textContent = '讀取於 ' + new Date().toLocaleString();
      return json;
    }

    // ===== API POST：使用 FormData，避免預檢 =====
    async function apiPatch(year, delta){
      // delta: { 'YYYY-MM-DD': 'full'|'free'|'' }
      const fd = new FormData();
      fd.append('token', ADMIN_TOKEN);
      fd.append('year', String(year));
      fd.append('delta', JSON.stringify(delta));

      const res = await fetch(API_BASE, { method:'POST', body:fd, redirect:'follow' });
      if(!res.ok) throw new Error('POST failed '+res.status);
      const out = await res.json();
      if(out?.data?.status){
        CACHE[year] = out.data.status;
      }else{
        // 保底：就地合併
        CACHE[year] = { ...(CACHE[year]||{}), ...delta };
      }
      document.querySelector('#lastSync').textContent = '已寫入於 ' + new Date().toLocaleString();
      return out;
    }

    // ===== 介面 =====
    const elYear = document.getElementById('yearSel');
    const elMonth = document.getElementById('startMonth');
    const elCals = document.getElementById('calendars');

    function initSelectors(){
      const now = new Date();
      const y0 = now.getFullYear() - 1;
      const y1 = now.getFullYear() + 2;
      elYear.innerHTML = '';
      for(let y=y0; y<=y1; y++){
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = y;
        if(y===now.getFullYear()) opt.selected = true;
        elYear.appendChild(opt);
      }
      elMonth.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    }

    function monthDays(y,m){
      const last = new Date(y, m, 0).getDate();
      return Array.from({length:last}, (_,i)=>i+1);
    }

    function renderCalendars(){
      const [Y, M] = elMonth.value.split('-').map(v=>parseInt(v,10));
      const months = [0,1,2].map(k=>{
        let y=Y, m=M+k;
        if(m>12){ y += Math.floor((m-1)/12); m = ((m-1)%12)+1; }
        return {y, m};
      });

      elCals.innerHTML = '';
      months.forEach(({y,m})=>{
        const cal = document.createElement('div');
        cal.className = 'calendar';

        const head = document.createElement('div');
        head.className = 'cal-head';
        head.innerHTML = `<div class="cal-title">${y} 年 ${m} 月</div><div class="counts" id="cnt-${y}-${m}"></div>`;
        cal.appendChild(head);

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr>
          <th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th><th>日</th>
        </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        // 以周為列
        const firstWd = (new Date(y,m-1,1).getDay()+6)%7; // Monday first
        const days = monthDays(y,m);
        let row = document.createElement('tr');
        for(let i=0;i<firstWd;i++) row.appendChild(document.createElement('td'));
        let fullCount=0, freeCount=0;

        days.forEach(day=>{
          const td = document.createElement('td');
          td.className = 'day' + (isWeekend(y,m,day)?' weekend':'');
          const dstr = ymd(y,m,day);
          const state = (CACHE[y]?.[dstr] || 'free'); // 預設可售
          if(state==='full') fullCount++; else freeCount++;

          td.innerHTML = `
            <span class="dateNo">${day}</span>
            <span class="state ${state==='full'?'full':'free'}">${state==='full'?'已滿':'可售'}</span>
          `;
          if(dstr===todayStr) td.classList.add('is-today');

          td.addEventListener('click', async ()=>{
            const cur = (CACHE[y]?.[dstr] || 'free');
            const next = cur==='full' ? 'free' : 'full';
            // 先本地更新（立即有感）
            CACHE[y] = CACHE[y] || {};
            CACHE[y][dstr] = next;
            td.querySelector('.state').className = 'state ' + (next==='full'?'full':'free');
            td.querySelector('.state').textContent = (next==='full'?'已滿':'可售');
            updateCounts(y,m);

            try{
              await apiPatch(y, { [dstr]: next });
            }catch(err){
              alert('寫入失敗：' + err.message);
              // 復原
              CACHE[y][dstr] = cur;
              td.querySelector('.state').className = 'state ' + (cur==='full'?'full':'free');
              td.querySelector('.state').textContent = (cur==='full'?'已滿':'可售');
              updateCounts(y,m);
            }
          });

          row.appendChild(td);
          // 換週
          if((firstWd + day) % 7 === 0){
            tbody.appendChild(row);
            row = document.createElement('tr');
          }
        });
        if(row.children.length) tbody.appendChild(row);

        table.appendChild(tbody);
        cal.appendChild(table);
        elCals.appendChild(cal);

        // 初次統計
        updateCounts(y,m);
      });
    }

    function updateCounts(y,m){
      const days = monthDays(y,m);
      let full=0, free=0;
      days.forEach(d=>{
        const dstr = ymd(y,m,d);
        const st = (CACHE[y]?.[dstr] || 'free');
        if(st==='full') full++; else free++;
      });
      const el = document.getElementById(`cnt-${y}-${m}`);
      if(el) el.textContent = `可售 ${String(free).padStart(2,'0')} • 已滿 ${String(full).padStart(2,'0')}`;
    }

    async function loadYearAndRender(){
      const year = parseInt(elYear.value,10);
      await apiGet(year);
      renderCalendars();
    }

    // 事件
    document.getElementById('btnReload').addEventListener('click', loadYearAndRender);
    document.getElementById('btnSetSatFull').addEventListener('click', async ()=>{
      const [Y, M] = elMonth.value.split('-').map(v=>parseInt(v,10));
      const days = monthDays(Y,M).filter(d => new Date(Y,M-1,d).getDay()===6);
      const delta = {};
      days.forEach(d=>delta[ymd(Y,M,d)]='full');
      // 本地先套
      CACHE[Y] = CACHE[Y] || {};
      Object.assign(CACHE[Y], delta);
      renderCalendars();
      try{ await apiPatch(Y, delta); }catch(e){ alert('寫入失敗：'+e.message); }
    });
    document.getElementById('btnSetAllFree').addEventListener('click', async ()=>{
      const [Y, M] = elMonth.value.split('-').map(v=>parseInt(v,10));
      const delta = {};
      monthDays(Y,M).forEach(d=>delta[ymd(Y,M,d)]='free');
      CACHE[Y] = CACHE[Y] || {};
      Object.assign(CACHE[Y], delta);
      renderCalendars();
      try{ await apiPatch(Y, delta); }catch(e){ alert('寫入失敗：'+e.message); }
    });

    // 初始化
    (async function(){
      initSelectors();
      document.getElementById('apiBase').textContent = API_BASE;
      document.getElementById('apiBase').addEventListener('click', ()=>window.open(API_BASE,'_blank'));
      await loadYearAndRender();
      // 切換選項時，若跨年就先拉該年
      elYear.addEventListener('change', loadYearAndRender);
      elMonth.addEventListener('change', renderCalendars);
    })();
  </script>
</body>
</html>
