<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>一斗夢包棟民宿 | 空房表（前台除錯版）</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,Helvetica,sans-serif;margin:24px}
  .wrap{max-width:1200px;margin:0 auto}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .calendar{border:1px solid #ddd;border-radius:12px;overflow:hidden}
  .cal-head{padding:8px 12px;border-bottom:1px solid #eee;font-weight:700}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{border:1px solid #eee;text-align:center;padding:6px}
  td.day{height:80px;position:relative}
  .num{position:absolute;top:6px;left:8px;font-size:13px;color:#444}
  .badge{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);padding:2px 6px;border-radius:999px;font-size:12px}
  .available{background:#c8e6c9}
  .full{background:#ffcdd2}
  #debug{white-space:pre-wrap;background:#111;color:#0f0;padding:10px;border-radius:8px;margin:16px 0;max-height:260px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <h2>前台（除錯版）</h2>
  <div>
    <label>年份：<select id="yearSelect"></select></label>
    <label>起始月份：<input type="month" id="startMonth"></label>
    <button id="btnGenerate">重新產生</button>
    <button id="btnPrev3">◀︎ 上三個月</button>
    <button id="btnNext3">下三個月 ▶︎</button>
    <span id="globalCounts" style="margin-left:8px;color:#666"></span>
  </div>
  <p>API_BASE：<code id="apiBaseEl"></code></p>
  <div id="debug" aria-live="polite">[debug log]</div>
  <div id="calendars" class="grid"></div>
</div>
<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbzKqF7-PKC1Hvg3iEQQVORK-JXqLO2rEKX_i97e87-HldSBzJR3r36DEOdNHaYQmibVBQ/exec';
document.getElementById('apiBaseEl').textContent = API_BASE;
const LABEL='空房表';
const CACHE={};

function log(){ const el=document.getElementById('debug'); el.textContent += '\\n' + Array.from(arguments).map(v=>typeof v==='string'?v:JSON.stringify(v)).join(' '); el.scrollTop = el.scrollHeight; }
window.addEventListener('error', e=>{ log('[window.error]', e.message || e); });
window.addEventListener('unhandledrejection', e=>{ log('[unhandledrejection]', String(e.reason||e)); });

function ymd(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split('T')[0]; }
function startOfMonth(d){ const x=new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
function endOfMonth(d){ const x=new Date(d); x.setMonth(x.getMonth()+1,0); x.setHours(0,0,0,0); return x; }
function addMonths(d,n){ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
function rangeDays(from,to){ const out=[]; const x=new Date(from); while(x<=to){ out.push(new Date(x)); x.setDate(x.getDate()+1);} return out; }

function getState(year,ds){ return (CACHE[year] && CACHE[year][ds]==='full') ? 'full':'available'; }

async function fetchYear(year){
  if(CACHE[year]) return CACHE[year];
  const u = new URL(API_BASE); u.searchParams.set('year', String(year));
  log('GET', u.toString());
  const res = await fetch(u.toString(), { headers:{'Accept':'application/json'} });
  log('status', res.status);
  const text = await res.text();
  log('body', text.slice(0,300));
  let data; try{ data = JSON.parse(text); }catch(e){ throw new Error('JSON parse error'); }
  CACHE[year] = data.status || {};
  return CACHE[year];
}

function renderCalendars(){
  const holder=document.getElementById('calendars');
  holder.innerHTML='';
  const selectedYear=parseInt(document.getElementById('yearSelect').value,10);
  const base = getStartMonthDate();
  const first = startOfMonth(base);

  let globalAvail=0, globalFull=0;

  for(let m=0;m<3;m++){
    const mStart = addMonths(first,m);
    const mEnd = endOfMonth(mStart);
    const lead = mStart.getDay();
    const days = rangeDays(mStart,mEnd);

    const cal=document.createElement('div'); cal.className='calendar';
    cal.innerHTML='<div class="cal-head">'+mStart.getFullYear()+' 年 '+(mStart.getMonth()+1)+' 月｜'+LABEL+'</div>';

    const tbl=document.createElement('table');
    const thead=document.createElement('thead');
    const trh=document.createElement('tr');
    '日,一,二,三,四,五,六'.split(',').forEach(w=>{ const th=document.createElement('th'); th.textContent=w; trh.appendChild(th); });
    thead.appendChild(trh); tbl.appendChild(thead);

    const tbody=document.createElement('tbody');
    let tr=document.createElement('tr');
    for(let i=0;i<lead;i++){ const td=document.createElement('td'); td.className='day'; tr.appendChild(td); }

    days.forEach((d,idx)=>{
      const td=document.createElement('td'); td.className='day';
      const ds=ymd(d);
      const num=document.createElement('div'); num.className='num'; num.textContent=d.getDate(); td.appendChild(num);

      const badge=document.createElement('div');
      const st=getState(mStart.getFullYear(), ds);
      badge.className='badge '+st; badge.textContent=(st==='full'?'已滿':'可售');
      td.appendChild(badge);

      if(st==='full') globalFull++; else globalAvail++;
      tr.appendChild(td);
      const dow=(lead+idx)%7; if(dow===6){ tbody.appendChild(tr); tr=document.createElement('tr'); }
    });
    if(tr.children.length){ while(tr.children.length<7){ const td=document.createElement('td'); td.className='day'; tr.appendChild(td);} tbody.appendChild(tr); }
    tbl.appendChild(tbody); cal.appendChild(tbl); holder.appendChild(cal);
  }
  document.getElementById('globalCounts').textContent='統計（3個月） 可售：'+globalAvail+'｜已滿：'+globalFull;
}

function getStartMonthDate(){
  const val=document.getElementById('startMonth').value;
  if(val){ const [y,m]=val.split('-').map(Number); return new Date(y, m-1, 1); }
  const y=parseInt(document.getElementById('yearSelect').value,10);
  return new Date(y, 0, 1);
}
function setStartMonthFromDate(date){
  const y=date.getFullYear(); const m=date.getMonth()+1;
  const yearSel=document.getElementById('yearSelect');
  if(y!==parseInt(yearSel.value,10)){
    const first=+yearSel.options[0].value; const last=+yearSel.options[yearSel.options.length-1].value;
    const target = Math.min(Math.max(y, first), last);
    yearSel.value=String(target);
  }
  document.getElementById('startMonth').value=`${y}-${String(m).padStart(2,'0')}`;
}

async function ensureYearsLoaded(years){
  const tasks = years.filter(y => !CACHE[y]).map(y => fetchYear(y).catch(err=>log('fetchYear error', String(err))));
  if(tasks.length) await Promise.all(tasks);
}

async function shiftMonths(n){
  const prev = getStartMonthDate();
  const next = addMonths(prev, n);
  setStartMonthFromDate(next);
  const needYears = new Set();
  for(let m=0;m<3;m++){ needYears.add(addMonths(startOfMonth(next), m).getFullYear()); }
  await ensureYearsLoaded([...needYears]);
  renderCalendars();
}

document.getElementById('btnGenerate').onclick = async ()=>{
  const y=parseInt(document.getElementById('yearSelect').value,10);
  await ensureYearsLoaded([y]);
  renderCalendars();
};
document.getElementById('btnPrev3').onclick=()=>shiftMonths(-3);
document.getElementById('btnNext3').onclick=()=>shiftMonths(3);

// 初始化年份
const now=new Date();
const thisYear=now.getFullYear();
const yearSel=document.getElementById('yearSelect');
for(let y=thisYear-1; y<=thisYear+7; y++){
  const opt=document.createElement('option'); opt.value=String(y); opt.textContent=String(y); yearSel.appendChild(opt);
}
yearSel.value=String(thisYear);
yearSel.onchange = async ()=>{
  const y=parseInt(yearSel.value,10);
  setStartMonthFromDate(new Date(y, (y===thisYear? now.getMonth():0), 1));
  await ensureYearsLoaded([y]);
  renderCalendars();
};
setStartMonthFromDate(now);

(async ()=>{
  const first = getStartMonthDate();
  const needYears = new Set();
  for(let m=0;m<3;m++){ needYears.add(addMonths(first, m).getFullYear()); }
  await ensureYearsLoaded([...needYears]);
  renderCalendars();
})();
</script>
</body>
</html>
"""

p = Path("/mnt/data/index_debug.html")
p.write_text(debug_html, encoding="utf-8")
print(str(p))

已分析
python
永遠顯示詳細資料

複製程式碼
from pathlib import Path

debug_html = """<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>一斗夢包棟民宿 | 空房表（前台除錯版）</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,Helvetica,sans-serif;margin:24px}
  .wrap{max-width:1200px;margin:0 auto}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .calendar{border:1px solid #ddd;border-radius:12px;overflow:hidden}
  .cal-head{padding:8px 12px;border-bottom:1px solid #eee;font-weight:700}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{border:1px solid #eee;text-align:center;padding:6px}
  td.day{height:80px;position:relative}
  .num{position:absolute;top:6px;left:8px;font-size:13px;color:#444}
  .badge{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);padding:2px 6px;border-radius:999px;font-size:12px}
  .available{background:#c8e6c9}
  .full{background:#ffcdd2}
  #debug{white-space:pre-wrap;background:#111;color:#0f0;padding:10px;border-radius:8px;margin:16px 0;max-height:260px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <h2>前台（除錯版）</h2>
  <div>
    <label>年份：<select id="yearSelect"></select></label>
    <label>起始月份：<input type="month" id="startMonth"></label>
    <button id="btnGenerate">重新產生</button>
    <button id="btnPrev3">◀︎ 上三個月</button>
    <button id="btnNext3">下三個月 ▶︎</button>
    <span id="globalCounts" style="margin-left:8px;color:#666"></span>
  </div>
  <p>API_BASE：<code id="apiBaseEl"></code></p>
  <div id="debug" aria-live="polite">[debug log]</div>
  <div id="calendars" class="grid"></div>
</div>
<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbzKqF7-PKC1Hvg3iEQQVORK-JXqLO2rEKX_i97e87-HldSBzJR3r36DEOdNHaYQmibVBQ/exec';
document.getElementById('apiBaseEl').textContent = API_BASE;
const LABEL='空房表';
const CACHE={};

function log(){ const el=document.getElementById('debug'); el.textContent += '\\n' + Array.from(arguments).map(v=>typeof v==='string'?v:JSON.stringify(v)).join(' '); el.scrollTop = el.scrollHeight; }
window.addEventListener('error', e=>{ log('[window.error]', e.message || e); });
window.addEventListener('unhandledrejection', e=>{ log('[unhandledrejection]', String(e.reason||e)); });

function ymd(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split('T')[0]; }
function startOfMonth(d){ const x=new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
function endOfMonth(d){ const x=new Date(d); x.setMonth(x.getMonth()+1,0); x.setHours(0,0,0,0); return x; }
function addMonths(d,n){ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
function rangeDays(from,to){ const out=[]; const x=new Date(from); while(x<=to){ out.push(new Date(x)); x.setDate(x.getDate()+1);} return out; }

function getState(year,ds){ return (CACHE[year] && CACHE[year][ds]==='full') ? 'full':'available'; }

async function fetchYear(year){
  if(CACHE[year]) return CACHE[year];
  const u = new URL(API_BASE); u.searchParams.set('year', String(year));
  log('GET', u.toString());
  const res = await fetch(u.toString(), { headers:{'Accept':'application/json'} });
  log('status', res.status);
  const text = await res.text();
  log('body', text.slice(0,300));
  let data; try{ data = JSON.parse(text); }catch(e){ throw new Error('JSON parse error'); }
  CACHE[year] = data.status || {};
  return CACHE[year];
}

function renderCalendars(){
  const holder=document.getElementById('calendars');
  holder.innerHTML='';
  const selectedYear=parseInt(document.getElementById('yearSelect').value,10);
  const base = getStartMonthDate();
  const first = startOfMonth(base);

  let globalAvail=0, globalFull=0;

  for(let m=0;m<3;m++){
    const mStart = addMonths(first,m);
    const mEnd = endOfMonth(mStart);
    const lead = mStart.getDay();
    const days = rangeDays(mStart,mEnd);

    const cal=document.createElement('div'); cal.className='calendar';
    cal.innerHTML='<div class="cal-head">'+mStart.getFullYear()+' 年 '+(mStart.getMonth()+1)+' 月｜'+LABEL+'</div>';

    const tbl=document.createElement('table');
    const thead=document.createElement('thead');
    const trh=document.createElement('tr');
    '日,一,二,三,四,五,六'.split(',').forEach(w=>{ const th=document.createElement('th'); th.textContent=w; trh.appendChild(th); });
    thead.appendChild(trh); tbl.appendChild(thead);

    const tbody=document.createElement('tbody');
    let tr=document.createElement('tr');
    for(let i=0;i<lead;i++){ const td=document.createElement('td'); td.className='day'; tr.appendChild(td); }

    days.forEach((d,idx)=>{
      const td=document.createElement('td'); td.className='day';
      const ds=ymd(d);
      const num=document.createElement('div'); num.className='num'; num.textContent=d.getDate(); td.appendChild(num);

      const badge=document.createElement('div'); const st=getState(mStart.getFullYear(), ds);
      badge.className='badge '+st; badge.textContent=(st==='full'?'已滿':'可售');
      td.appendChild(badge);

      if(st==='full') globalFull++; else globalAvail++;
      tr.appendChild(td);
      const dow=(lead+idx)%7; if(dow===6){ tbody.appendChild(tr); tr=document.createElement('tr'); }
    });
    if(tr.children.length){ while(tr.children.length<7){ const td=document.createElement('td'); td.className='day'; tr.appendChild(td);} tbody.appendChild(tr); }
    tbl.appendChild(tbody); cal.appendChild(tbl); holder.appendChild(cal);
  }
  document.getElementById('globalCounts').textContent='統計（3個月） 可售：'+globalAvail+'｜已滿：'+globalFull;
}

function getStartMonthDate(){
  const val=document.getElementById('startMonth').value;
  if(val){ const [y,m]=val.split('-').map(Number); return new Date(y, m-1, 1); }
  const y=parseInt(document.getElementById('yearSelect').value,10);
  return new Date(y, 0, 1);
}
function setStartMonthFromDate(date){
  const y=date.getFullYear(); const m=date.getMonth()+1;
  const yearSel=document.getElementById('yearSelect');
  if(y!==parseInt(yearSel.value,10)){
    const first=+yearSel.options[0].value; const last=+yearSel.options[yearSel.options.length-1].value;
    const target = Math.min(Math.max(y, first), last);
    yearSel.value=String(target);
  }
  document.getElementById('startMonth').value=`${y}-${String(m).padStart(2,'0')}`;
}

async function ensureYearsLoaded(years){
  const tasks = years.filter(y => !CACHE[y]).map(y => fetchYear(y).catch(err=>log('fetchYear error', String(err))));
  if(tasks.length) await Promise.all(tasks);
}

async function shiftMonths(n){
  const prev = getStartMonthDate();
  const next = addMonths(prev, n);
  setStartMonthFromDate(next);
  const needYears = new Set();
  for(let m=0;m<3;m++){ needYears.add(addMonths(startOfMonth(next), m).getFullYear()); }
  await ensureYearsLoaded([...needYears]);
  renderCalendars();
}

document.getElementById('btnGenerate').onclick = async ()=>{
  const y=parseInt(document.getElementById('yearSelect').value,10);
  await ensureYearsLoaded([y]);
  renderCalendars();
};
document.getElementById('btnPrev3').onclick=()=>shiftMonths(-3);
document.getElementById('btnNext3').onclick=()=>shiftMonths(3);

// 初始化年份
const now=new Date();
const thisYear=now.getFullYear();
const yearSel=document.getElementById('yearSelect');
for(let y=thisYear-1; y<=thisYear+7; y++){
  const opt=document.createElement('option'); opt.value=String(y); opt.textContent=String(y); yearSel.appendChild(opt);
}
yearSel.value=String(thisYear);
yearSel.onchange = async ()=>{
  const y=parseInt(yearSel.value,10);
  setStartMonthFromDate(new Date(y, (y===thisYear? now.getMonth():0), 1));
  await ensureYearsLoaded([y]);
  renderCalendars();
};
setStartMonthFromDate(now);

(async ()=>{
  const first = getStartMonthDate();
  const needYears = new Set();
  for(let m=0;m<3;m++){ needYears.add(addMonths(first, m).getFullYear()); }
  await ensureYearsLoaded([...needYears]);
  renderCalendars();
})();
</script>
</body>
</html>
